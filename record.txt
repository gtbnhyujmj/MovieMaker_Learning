ğŸ”§ ç¨‹å¼ç¢¼é–‹å§‹ï¼
python
è¤‡è£½
ç·¨è¼¯
# å®‰è£éœ€è¦çš„å¥—ä»¶
!pip install moviepy opencv-python-headless --quiet
python
è¤‡è£½
ç·¨è¼¯
import cv2
import os
import numpy as np
from moviepy.editor import VideoFileClip, ImageSequenceClip

# è¨­å®šè³‡æ–™å¤¾ä½ç½®
bg_folder = "/content/backgrounds"
char_folder = "/content/characters"
overlay_folder = "/content/overlays"

# è®€å–äººç‰©å’Œåœ–æ¡ˆåœ–ç‰‡
char_path = os.path.join(char_folder, "char1.png")
overlay_path = os.path.join(overlay_folder, "top_icon.png")

char_img = cv2.imread(char_path, cv2.IMREAD_UNCHANGED)
overlay_img = cv2.imread(overlay_path, cv2.IMREAD_UNCHANGED)
ğŸ§° å·¥å…·å‡½æ•¸ï¼šç”¨ä¾†è²¼ä¸Šé€æ˜åœ–å±¤
python
è¤‡è£½
ç·¨è¼¯
# å°‡ overlay è²¼åœ¨ background ä¸Šï¼ˆæ”¯æ´é€æ˜ PNGï¼‰
def overlay_image(background, overlay, position):
    x = position[0]
    y = position[1]
    
    bh, bw = background.shape[:2]
    oh, ow = overlay.shape[:2]
    
    if x + ow > bw or y + oh > bh:
        print("è¶…å‡ºé‚Šç•Œï¼Œç•¥éè²¼åœ–")
        return background

    if overlay.shape[2] == 4:
        alpha = overlay[:, :, 3] / 255.0
        for c in range(3):
            background[y:y+oh, x:x+ow, c] = (
                alpha * overlay[:, :, c] + (1 - alpha) * background[y:y+oh, x:x+ow, c]
            )
    else:
        background[y:y+oh, x:x+ow] = overlay

    return background
ğŸ–¼ï¸ åˆæˆä¸€å¼µç•«é¢
python
è¤‡è£½
ç·¨è¼¯
# åˆæˆå–®å¼µç•«é¢ï¼šäººç‰©æ”¾ä¸­é–“ï¼Œåœ–æ¡ˆæ”¾åº•ä¸‹
def compose_frame(bg_frame, char_img, overlay_img, char_y_offset_ratio):
    h, w = bg_frame.shape[:2]
    output = bg_frame.copy()

    # èª¿æ•´äººç‰©åœ–ç‰‡å¤§å°ï¼ˆå¯¬åº¦ 40%ï¼‰
    char_width = int(w * 0.4)
    char_height = int(char_img.shape[0] * char_width / char_img.shape[1])
    char_resized = cv2.resize(char_img, (char_width, char_height))

    # è¨ˆç®—äººç‰©ä½ç½®ï¼ˆä¸­é–“ + offsetï¼‰
    char_x = (w - char_width) // 2
    char_y = int((h - char_height) // 2 + h * char_y_offset_ratio)

    output = overlay_image(output, char_resized, (char_x, char_y))

    # èª¿æ•´åœ–æ¡ˆå¤§å°ï¼ˆå¯¬åº¦ 30%ï¼‰
    overlay_width = int(w * 0.3)
    overlay_height = int(overlay_img.shape[0] * overlay_width / overlay_img.shape[1])
    overlay_resized = cv2.resize(overlay_img, (overlay_width, overlay_height))

    # åœ–æ¡ˆæ”¾åœ¨ç•«é¢ä¸‹ 1/3 è™•
    overlay_x = (w - overlay_width) // 2
    overlay_y = int(h * 0.33)

    output = overlay_image(output, overlay_resized, (overlay_x, overlay_y))

    return output
ğŸ“½ï¸ è™•ç†èƒŒæ™¯ï¼šå¯ä»¥æ˜¯å½±ç‰‡ä¹Ÿå¯ä»¥æ˜¯åœ–ç‰‡
python
è¤‡è£½
ç·¨è¼¯
# é¸æ“‡èƒŒæ™¯æª”æ¡ˆ
bg_file = os.path.join(bg_folder, "bg1.mp4")  # æˆ– .png
is_video = bg_file.endswith(".mp4")

char_offset_ratio = 0.0  # å¯ä»¥è¨­æˆ 0.1 æˆ– -0.1 è®“äººç‰©ä¸Šä¸‹ç§»

if is_video:
    # èƒŒæ™¯æ˜¯å½±ç‰‡
    clip = VideoFileClip(bg_file)
    fps = clip.fps
    new_frames = []

    for frame in clip.iter_frames():
        frame_bgr = cv2.cvtColor(frame, cv2.COLOR_RGB2BGR)
        composed = compose_frame(frame_bgr, char_img, overlay_img, char_offset_ratio)
        new_frames.append(cv2.cvtColor(composed, cv2.COLOR_BGR2RGB))

    # å„²å­˜æ–°å½±ç‰‡
    output_path = "/content/output.mp4"
    result_clip = ImageSequenceClip(new_frames, fps=fps)
    result_clip.write_videofile(output_path, codec="libx264")

else:
    # èƒŒæ™¯æ˜¯åœ–ç‰‡
    bg_img = cv2.imread(bg_file)
    composed = compose_frame(bg_img, char_img, overlay_img, char_offset_ratio)

    # å„²å­˜æ–°åœ–ç‰‡
    output_path = "/content/output.png"
    cv2.imwrite(output_path, composed)

print("åˆæˆå®Œæˆï¼è¼¸å‡ºæª”æ¡ˆï¼š " + output_path)
ğŸ‰ æˆåŠŸä¹‹å¾Œä½ æœƒå¾—åˆ°ï¼š
output.mp4ï¼šåˆæˆå½±ç‰‡

æˆ– output.pngï¼šåˆæˆéœæ…‹åœ–ç‰‡
